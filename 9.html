<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Onet Crystal Pro 2026 üíé</title>
    <style>
        /* CSS ES5 - T·ªëi ∆∞u cho Safari iOS 9 */
        body { 
            margin: 0; padding: 0; background-color: #2ecc71; /* N·ªÅn ƒë·ªìng c·ªè m·∫∑c ƒë·ªãnh */
            background-size: cover; background-position: center; background-attachment: fixed;
            font-family: Arial, sans-serif; color: white;
            display: block; height: 100vh; overflow: hidden;
        }

        /* HEADER & INFO */
        .header { background: rgba(0,0,0,0.7); padding: 8px 0; border-bottom: 2px solid #f1c40f; }
        .info { text-align: center; font-weight: bold; font-size: 14px; color: #f1c40f; }
        .info span { margin: 0 10px; border: 1px solid rgba(255,255,255,0.2); padding: 2px 5px; border-radius: 4px; }
        .timer-box { width: 90%; height: 8px; background: #333; margin: 8px auto; border-radius: 5px; overflow: hidden; border: 1px solid #555; }
        #timer-bar { width: 100%; height: 100%; background: linear-gradient(to right, #00ff00, #ffff00, #ff0000); }

        /* MENU BUTTONS */
        .menu { text-align: center; padding: 10px; background: rgba(0,0,0,0.4); }
        .btn { 
            display: inline-block; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.4); border-radius: 8px;
            padding: 10px 15px; margin: 3px; color: white; font-size: 12px; font-weight: bold;
            text-transform: uppercase;
        }

        /* GAME AREA */
        .game-area { position: relative; width: 100%; height: 70vh; padding-top: 10px; }
        #board-table { margin: 0 auto; border-collapse: separate; border-spacing: 3px; }
        .tile { 
            width: 48px; height: 48px; background: rgba(255,255,255,0.15); 
            border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
            font-size: 26px; text-align: center; vertical-align: middle;
            box-shadow: inset 0 0 5px rgba(255,255,255,0.1);
        }
        .tile.active { background: #ff3e3e; border-color: #fff; box-shadow: 0 0 15px #ff3e3e; transform: scale(1.05); }
        .tile.hide { visibility: hidden; }

        /* CLASSIC MODE (iPHONE 4 STYLE) */
        body.classic { background-color: #7f8c8d; }
        body.classic .tile { background: #fff; color: #000; border: 2px solid #95a5a6; box-shadow: 2px 2px 0 #7f8c8d; }
        body.classic .btn { background: #34495e; border: 1px solid #2c3e50; }

        #line-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 99; }
    </style>
</head>
<body onload="autoStart()"> 

<audio id="m_bg" loop src="Nhac.mp3"></audio>
<audio id="s_ok" src="dung.mp3"></audio>
<audio id="s_no" src="sai.mp3"></audio>
<audio id="s_tap" src="khi_nhan_nut.mp3"></audio>

<div class="header">
    <div class="info">
        üí∞ XU: <span id="xu">500</span> 
        LV: <span id="lv">1</span> 
        PTS: <span id="pts">0</span>
    </div>
    <div class="timer-box"><div id="timer-bar"></div></div>
</div>

<div class="menu">
    <div class="btn" style="color:#00ffff" onclick="toggleUI()">üåì GIAO DI·ªÜN</div>
    <div class="btn" onclick="manualShuffle()">üîÑ ƒê·∫¢O (100)</div>
    <div class="btn" onclick="changeBg()">üñºÔ∏è ƒê·ªîI N·ªÄN</div>
</div>

<div class="game-area">
    <canvas id="line-canvas"></canvas>
    <table id="board-table"></table>
</div>

<script>
    // VAR ONLY - KH√îNG D√ôNG CONST/LET V√å SAFARI 9 S·∫º L·ªñI
    var R = 7, C = 10;
    var icons = ['üßß','üèÆ','üçä','üå∏','üß®','üéã','üí∞','‚ú®','üçé','üçë','üçç','üçâ','üç±','ü¶Å'];
    var bgs = ['1.jpeg', '2.jpeg', '3.jpeg', '4.jpeg'];
    var currentBgIndex = 0;
    var map = [], pick = null, xu = 500, pts = 0, lv = 1, time = 100, timer;

    function autoStart() {
        // Load ch·∫ø ƒë·ªô giao di·ªán
        var savedMode = localStorage.getItem('onet_ui_mode') || 'crystal';
        if(savedMode === 'classic') document.body.className = 'classic';
        
        loadFromDevice();
        updateBg();
        init();
        
        // K√≠ch ho·∫°t nh·∫°c khi ch·∫°m l·∫ßn ƒë·∫ßu (B·∫Øt bu·ªôc cho iOS)
        document.body.onclick = function() {
            var m = document.getElementById('m_bg');
            if(m) m.play();
            document.body.onclick = null;
        };
    }

    function sound(id) {
        var s = document.getElementById(id);
        if(s) { s.currentTime = 0; s.play(); }
    }

    function init() {
        if(timer) clearInterval(timer);
        time = 100; map = [];
        for(var i=0; i<R+2; i++) {
            map[i] = [];
            for(var j=0; j<C+2; j++) map[i][j] = null;
        }

        var items = [];
        for(var i=0; i<(R*C)/2; i++) {
            items.push(icons[i % icons.length]);
            items.push(icons[i % icons.length]);
        }
        items.sort(function() { return Math.random() - 0.5; });

        var k = 0;
        for(var r=1; r<=R; r++) {
            for(var c=1; c<=C; c++) map[r][c] = items[k++];
        }
        draw();
        startTimer();
    }

    function draw() {
        var table = document.getElementById('board-table');
        table.innerHTML = '';
        for(var r=1; r<=R; r++) {
            var tr = document.createElement('tr');
            for(var c=1; c<=C; c++) {
                var td = document.createElement('td');
                td.className = 'tile' + (map[r][c] ? '' : ' hide');
                td.innerHTML = map[r][c] || '';
                td.onclick = (function(rr, cc, el) {
                    return function() { clickTile(el, rr, cc); };
                })(r, c, td);
                tr.appendChild(td);
            }
            table.appendChild(tr);
        }
        document.getElementById('xu').innerHTML = xu;
        document.getElementById('lv').innerHTML = lv;
        document.getElementById('pts').innerHTML = pts;
        saveToDevice();
    }

    function clickTile(el, r, c) {
        if(!map[r][c]) return;
        sound('s_tap');
        if(!pick) {
            pick = {el: el, r: r, c: c};
            el.className += ' active';
        } else {
            if(pick.r === r && pick.c === c) {
                el.className = el.className.replace(' active', '');
                pick = null;
                return;
            }
            if(map[pick.r][pick.c] === map[r][c]) {
                sound('s_ok');
                map[pick.r][pick.c] = map[r][c] = null;
                xu += 10; pts += 5;
                pick = null;
                draw();
            } else {
                sound('s_no'); // Ti·∫øng "·ªêt ·ªì" c·ªßa n√≠
                pick.el.className = pick.el.className.replace(' active', '');
                pick = {el: el, r: r, c: c};
                el.className += ' active';
            }
        }
    }

    function startTimer() {
        timer = setInterval(function() {
            time -= 0.15;
            document.getElementById('timer-bar').style.width = time + "%";
            if(time <= 0) {
                clearInterval(timer);
                alert("H·∫øt gi·ªù! Ch∆°i l·∫°i nh√© n√≠.");
                init();
            }
        }, 1000);
    }

    function toggleUI() {
        sound('s_tap');
        if(document.body.className === 'classic') {
            document.body.className = '';
            localStorage.setItem('onet_ui_mode', 'crystal');
        } else {
            document.body.className = 'classic';
            localStorage.setItem('onet_ui_mode', 'classic');
        }
    }

    function changeBg() {
        sound('s_tap');
        currentBgIndex = (currentBgIndex + 1) % bgs.length;
        updateBg();
    }

    function updateBg() {
        document.body.style.backgroundImage = "url('" + bgs[currentBgIndex] + "')";
    }

    function manualShuffle() {
        if(xu >= 100) { xu -= 100; sound('s_tap'); init(); }
    }

    function saveToDevice() {
        var data = { xu: xu, lv: lv, pts: pts, bg: currentBgIndex };
        localStorage.setItem('onet_pro_save', JSON.stringify(data));
    }

    function loadFromDevice() {
        var saved = localStorage.getItem('onet_pro_save');
        if(saved) {
            var d = JSON.parse(saved);
            xu = d.xu; lv = d.lv; pts = d.pts; currentBgIndex = d.bg || 0;
        }
    }
</script>
</body>
</html>
