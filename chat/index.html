<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal Chat Friend Menu üíé</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #7cd342; --glass: rgba(255, 255, 255, 0.05); --blur: blur(1px); }
        body {
            margin: 0; font-family: 'Segoe UI', sans-serif; height: 100vh;
            background: #0a0a0a url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1932&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover; color: white; display: flex; flex-direction: column; overflow: hidden;
        }
        .container {
            flex: 1; display: flex; flex-direction: column; max-width: 480px; margin: 10px auto;
            width: 92%; background: var(--glass); backdrop-filter: var(--blur);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .header { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        
        /* Menu Ch·ªçn B·∫°n */
        .friend-menu {
            padding: 10px; display: flex; gap: 8px; overflow-x: auto;
            background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .friend-menu::-webkit-scrollbar { height: 0px; }
        .friend-item {
            padding: 5px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px; font-size: 11px; white-space: nowrap; cursor: pointer;
        }
        .friend-item.active { border-color: var(--accent); color: var(--accent); background: rgba(124, 211, 66, 0.1); }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px; border-radius: 12px; max-width: 80%; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(2px); }
        .sent { align-self: flex-end; background: var(--accent); color: black; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: rgba(255,255,255,0.1); border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        .input-area { padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1); border-radius: 0 0 20px 20px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        input[type="text"] { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; color: white; flex: 1; outline: none; }
        .btn-add { background: none; border: 1px solid var(--accent); color: var(--accent); border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div style="font-size: 10px; opacity: 0.6;">ID C·ª¶A N√ç: <b id="my-id-display" style="color:var(--accent); font-size:16px;">----</b></div>
            <div style="margin-top:10px; display:flex; gap:5px; justify-content:center;">
                <input type="text" id="peer-id-input" placeholder="ID b·∫°n m·ªõi..." style="width:100px; font-size:12px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:5px; padding:4px;">
                <button class="btn-add" onclick="addFriend()">+</button>
            </div>
        </div>

        <div class="friend-menu" id="friend-menu">
            <div class="friend-item active" onclick="selectFriend('', this)">T·∫•t c·∫£</div>
        </div>

        <div id="chat-box"></div>

        <div class="input-area">
            <div class="controls">
                <label style="cursor:pointer; font-size:18px;">üìÅ<input type="file" id="file-input" style="display:none" onchange="sendFile()"></label>
                <input type="text" id="message-input" placeholder="Nh·∫Øn g√¨ ƒëi n√≠...">
                <button onclick="sendMessage()" style="background:var(--accent); border:none; padding:10px 15px; border-radius:10px; font-weight:bold; cursor:pointer;">G·ª¨I</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn;
        const chatBox = document.getElementById('chat-box');
        const friendMenu = document.getElementById('friend-menu');
        const STORAGE_KEY = 'crystal_friends_v1';
        const MSG_KEY = 'crystal_msg_v1';
        const ID_KEY = 'crystal_fixed_id';

        function initPeer() {
            let fixedId = localStorage.getItem(ID_KEY) || Math.floor(1000 + Math.random() * 9000).toString();
            localStorage.setItem(ID_KEY, fixedId);
            
            peer = new Peer(fixedId);
            peer.on('open', (id) => document.getElementById('my-id-display').innerText = id);
            peer.on('connection', (connection) => { conn = connection; setupConn(); });
            
            loadFriends();
            loadMessages();
        }

        // 1. Qu·∫£n l√Ω danh b·∫°
        function addFriend() {
            const id = document.getElementById('peer-id-input').value.trim();
            if (!id) return;
            const name = prompt("ƒê·∫∑t t√™n cho n√≠ n√†y:", "N√≠ " + id);
            if (!name) return;

            let friends = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            if (!friends.find(f => f.id === id)) {
                friends.push({ id, name });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(friends));
                loadFriends();
            }
            document.getElementById('peer-id-input').value = id;
        }

        function loadFriends() {
            let friends = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            friendMenu.innerHTML = '<div class="friend-item active" onclick="selectFriend(\'\', this)">T·∫•t c·∫£</div>';
            friends.forEach(f => {
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.innerText = f.name;
                item.onclick = () => selectFriend(f.id, item);
                friendMenu.appendChild(item);
            });
        }

        function selectFriend(id, el) {
            document.querySelectorAll('.friend-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('peer-id-input').value = id;
            // L·ªçc tin nh·∫Øn (t√≠nh nƒÉng n√¢ng cao c√≥ th·ªÉ th√™m sau)
        }

        // 2. Chat logic
        function setupConn() {
            conn.on('data', (data) => appendAndSave('N√≠', data, 'received', conn.peer));
        }

        function sendMessage() {
            const targetId = document.getElementById('peer-id-input').value.trim();
            const msg = document.getElementById('message-input').value.trim();
            if (!msg || !targetId) return;

            if (!conn || conn.peer !== targetId) {
                conn = peer.connect(targetId);
                setupConn();
                setTimeout(sendMessage, 800);
                return;
            }
            conn.send(msg);
            appendAndSave('B·∫°n', msg, 'sent', targetId);
            document.getElementById('message-input').value = '';
        }

        function sendFile() {
            const file = document.getElementById('file-input').files[0];
            const targetId = document.getElementById('peer-id-input').value.trim();
            if (!file || !targetId) return;

            const reader = new FileReader();
            reader.onload = () => {
                const data = { name: file.name, type: file.type, data: reader.result };
                if (!conn || conn.peer !== targetId) {
                    conn = peer.connect(targetId);
                    setupConn();
                    setTimeout(() => { conn.send(data); appendAndSave('B·∫°n', data, 'sent', targetId); }, 1000);
                } else {
                    conn.send(data);
                    appendAndSave('B·∫°n', data, 'sent', targetId);
                }
            };
            reader.readAsDataURL(file);
        }

        function appendAndSave(sender, content, type, peerId) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            appendMessage(sender, content, type, time);
            let history = JSON.parse(localStorage.getItem(MSG_KEY)) || [];
            history.push({ sender, content, type, time, peerId });
            localStorage.setItem(MSG_KEY, JSON.stringify(history));
        }

        function appendMessage(sender, content, type, time) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            let html = `<strong>${sender}:</strong> `;
            if (typeof content === 'object') {
                if (content.type.startsWith('image/')) html += `<img src="${content.data}">`;
                else html += `<a href="${content.data}" download="${content.name}" style="color:var(--accent)">üìÅ ${content.name}</a>`;
            } else { html += `<span>${content}</span>`; }
            html += `<div style="font-size:8px; opacity:0.4; margin-top:5px; text-align:right;">${time}</div>`;
            div.innerHTML = html;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function loadMessages() {
            let history = JSON.parse(localStorage.getItem(MSG_KEY)) || [];
            history.forEach(m => appendMessage(m.sender, m.content, m.type, m.time));
        }

        initPeer();
    </script>
</body>
</html>
