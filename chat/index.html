<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal Chat Anti-Hide üíé</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #7cd342; --glass: rgba(255, 255, 255, 0.05); --blur: blur(1px); }
        
        /* Fix chi·ªÅu cao dynamic ƒë·ªÉ kh√¥ng m·∫•t n√∫t khi hi·ªán b√†n ph√≠m */
        body {
            margin: 0; font-family: 'Segoe UI', sans-serif; 
            height: 100vh; height: 100dvh; /* ƒê∆°n v·ªã lanh l·ª£i cho di ƒë·ªông */
            background: #0a0a0a url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1932&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover; color: white;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .container {
            flex: 1; display: flex; flex-direction: column;
            width: 100%; max-width: 480px; margin: 0 auto;
            background: var(--glass); backdrop-filter: var(--blur);
            border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; /* Gi·ªØ m·ªçi th·ª© b√™n trong */
        }

        .header { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; flex-shrink: 0; }
        
        .friend-menu {
            padding: 8px; display: flex; gap: 8px; overflow-x: auto;
            background: rgba(0,0,0,0.2); flex-shrink: 0;
        }
        .friend-item {
            padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 12px;
            font-size: 11px; white-space: nowrap; cursor: pointer; border: 1px solid transparent;
        }
        .friend-item.active { border-color: var(--accent); color: var(--accent); }

        /* H√≤m chat t·ª± co gi√£n lanh l·ª£i */
        #chat-box { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; gap: 10px;
            -webkit-overflow-scrolling: touch; /* M∆∞·ª£t cho Samsung */
        }

        .msg { padding: 10px; border-radius: 12px; max-width: 80%; font-size: 14px; border: 1px solid rgba(255,255,255,0.1); }
        .sent { align-self: flex-end; background: var(--accent); color: black; }
        .received { align-self: flex-start; background: rgba(255,255,255,0.1); }
        .msg img { max-width: 100%; border-radius: 8px; }

        /* Khu v·ª±c nh·∫≠p li·ªáu lu√¥n b√°m ƒë√°y */
        .input-area { 
            padding: 10px; background: rgba(0,0,0,0.4); 
            border-top: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0; padding-bottom: env(safe-area-inset-bottom); /* Fix cho m√°y c√≥ tai th·ªè/n√∫t ·∫£o */
        }
        .controls { display: flex; gap: 8px; align-items: center; }
        
        input[type="text"] { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            padding: 10px; border-radius: 8px; color: white; flex: 1; outline: none; font-size: 16px; /* 16px ƒë·ªÉ ko b·ªã auto zoom tr√™n iPhone */
        }
        
        .btn-send { background: var(--accent); border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .id-badge { color: var(--accent); font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div class="id-badge">ID: <span id="my-id-display">----</span></div>
            <div style="margin-top:5px; display:flex; gap:5px; justify-content:center;">
                <input type="text" id="peer-id-input" placeholder="Nh·∫≠p ID b·∫°n..." style="width:100px; font-size:11px; padding:3px;">
                <button onclick="addFriend()" style="font-size:10px;">L∆ØU B·∫†N</button>
            </div>
        </div>

        <div class="friend-menu" id="friend-menu">
            <div class="friend-item active">T·∫•t c·∫£</div>
        </div>

        <div id="chat-box"></div>

        <div class="input-area">
            <div class="controls">
                <label style="cursor:pointer; font-size:18px;">üìÅ<input type="file" id="file-input" style="display:none" onchange="sendFile()"></label>
                <input type="text" id="message-input" placeholder="Nh·∫Øn g√¨ ƒëi n√≠...">
                <button class="btn-send" onclick="sendMessage()">G·ª¨I</button>
            </div>
        </div>
    </div>

    <script>
        let peer, conn;
        const chatBox = document.getElementById('chat-box');
        const STORAGE_FRIENDS = 'crystal_friends_v2';
        const STORAGE_MSGS = 'crystal_msgs_v2';
        const ID_KEY = 'crystal_fixed_id';

        function initPeer() {
            let fixedId = localStorage.getItem(ID_KEY) || Math.floor(1000 + Math.random() * 9000).toString();
            localStorage.setItem(ID_KEY, fixedId);
            
            peer = new Peer(fixedId);
            peer.on('open', (id) => document.getElementById('my-id-display').innerText = id);
            peer.on('connection', (c) => { conn = c; setupConn(); });
            
            loadFriends();
            loadMessages();
            
            // Cu·ªôn xu·ªëng cu·ªëi ngay khi m·ªü
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 500);
        }

        function addFriend() {
            const id = document.getElementById('peer-id-input').value.trim();
            if (!id) return;
            const name = prompt("ƒê·∫∑t t√™n cho n√≠:", "B·∫°n " + id);
            if (!name) return;
            let friends = JSON.parse(localStorage.getItem(STORAGE_FRIENDS)) || [];
            if (!friends.find(f => f.id === id)) {
                friends.push({ id, name });
                localStorage.setItem(STORAGE_FRIENDS, JSON.stringify(friends));
                loadFriends();
            }
        }

        function loadFriends() {
            let friends = JSON.parse(localStorage.getItem(STORAGE_FRIENDS)) || [];
            const menu = document.getElementById('friend-menu');
            menu.innerHTML = '<div class="friend-item active" onclick="selFriend(\'\', this)">T·∫•t c·∫£</div>';
            friends.forEach(f => {
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.innerText = f.name;
                item.onclick = () => selFriend(f.id, item);
                menu.appendChild(item);
            });
        }

        function selFriend(id, el) {
            document.querySelectorAll('.friend-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('peer-id-input').value = id;
        }

        function setupConn() {
            conn.on('data', (data) => appendAndSave('N√≠', data, 'received'));
        }

        function sendMessage() {
            const targetId = document.getElementById('peer-id-input').value.trim();
            const msg = document.getElementById('message-input').value.trim();
            if (!msg || !targetId) return;

            if (!conn || conn.peer !== targetId) {
                conn = peer.connect(targetId);
                setupConn();
                setTimeout(sendMessage, 800);
                return;
            }
            conn.send(msg);
            appendAndSave('B·∫°n', msg, 'sent');
            document.getElementById('message-input').value = '';
        }

        function sendFile() {
            const file = document.getElementById('file-input').files[0];
            const targetId = document.getElementById('peer-id-input').value.trim();
            if (!file || !targetId) return;
            const reader = new FileReader();
            reader.onload = () => {
                const data = { name: file.name, type: file.type, data: reader.result };
                if (!conn || conn.peer !== targetId) {
                    conn = peer.connect(targetId);
                    setupConn();
                    setTimeout(() => { conn.send(data); appendAndSave('B·∫°n', data, 'sent'); }, 1000);
                } else { conn.send(data); appendAndSave('B·∫°n', data, 'sent'); }
            };
            reader.readAsDataURL(file);
        }

        function appendAndSave(sender, content, type) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            appendMessage(sender, content, type, time);
            let history = JSON.parse(localStorage.getItem(STORAGE_MSGS)) || [];
            history.push({ sender, content, type, time });
            localStorage.setItem(STORAGE_MSGS, JSON.stringify(history));
        }

        function appendMessage(sender, content, type, time) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            let html = `<strong>${sender}:</strong> `;
            if (typeof content === 'object') {
                if (content.type.startsWith('image/')) html += `<img src="${content.data}">`;
                else html += `<a href="${content.data}" download="${content.name}" style="color:var(--accent)">üìÅ ${content.name}</a>`;
            } else { html += `<span>${content}</span>`; }
            html += `<div style="font-size:8px; opacity:0.4; margin-top:5px; text-align:right;">${time}</div>`;
            div.innerHTML = html;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function loadMessages() {
            let history = JSON.parse(localStorage.getItem(STORAGE_MSGS)) || [];
            history.forEach(m => appendMessage(m.sender, m.content, m.type, m.time));
        }

        initPeer();
    </script>
</body>
</html>
