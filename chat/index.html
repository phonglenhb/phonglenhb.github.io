<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crystal 4G Pro üíé</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --accent: #7cd342; --border: rgba(255, 255, 255, 0.2); --glass: rgba(255,255,255,0.1); }
        body {
            margin: 0; font-family: -apple-system, sans-serif; height: 100dvh;
            background: #000 url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1932&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover; color: white; display: flex; flex-direction: column; overflow: hidden;
        }
        .container { flex: 1; display: flex; flex-direction: column; width: 100%; max-width: 480px; margin: 0 auto; background: transparent !important; backdrop-filter: blur(1px); border-left: 1px solid var(--border); border-right: 1px solid var(--border); }
        
        .header { padding: 15px; text-align: center; background: transparent !important; }
        #status-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 10px; font-weight: bold; background: rgba(0,0,0,0.4); border: 1px solid var(--border); transition: 0.3s; }
        .online { color: var(--accent); border-color: var(--accent) !important; box-shadow: 0 0 10px var(--accent); }
        .offline { color: #ff453a; border-color: #ff453a !important; }
        .typing { font-style: italic; font-size: 10px; color: var(--accent); height: 15px; margin-top: 5px; }

        .friend-menu { padding: 10px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid var(--border); background: transparent !important; }
        .friend-menu::-webkit-scrollbar { display: none; }
        .friend-item { padding: 8px 16px; background: var(--glass); border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; position: relative; border: 1px solid var(--border); transition: 0.3s; }
        .friend-item.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }
        .has-new::after { content: ''; position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #ff453a; border-radius: 50%; border: 2px solid black; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: transparent !important; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 14px; border: 1px solid var(--border); backdrop-filter: blur(10px); position: relative; }
        .sent { align-self: flex-end; background: var(--accent); color: black; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: var(--glass); border-bottom-left-radius: 2px; }
        .pending { opacity: 0.6; border-style: dashed; }
        .msg img, .msg video { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; }
        .msg-time { font-size: 8px; opacity: 0.5; margin-top: 4px; text-align: right; }

        .input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2) !important; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .main-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px 18px; border-radius: 25px; color: white; outline: none; font-size: 14px; }
        .btn-icon { font-size: 24px; cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .btn-send { width: 42px; height: 42px; border-radius: 50%; background: var(--accent); color: black; border: none; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="color:var(--accent); font-weight:bold; font-size:18px;" id="my-id">ƒêang kh·ªüi t·∫°o ID...</div>
            <div id="status-badge">CH·ªú K·∫æT N·ªêI...</div>
            <div id="typing-indicator" class="typing"></div>
            <div style="margin-top:10px; display: flex; justify-content: center; gap: 5px;">
                <input type="text" id="peer-id-input" placeholder="Nh·∫≠p ID b·∫°n..." style="background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:15px; padding:6px 12px; color:white; width:110px; outline: none;">
                <button onclick="addFriend()" style="background:var(--accent); border:none; border-radius:15px; padding:6px 15px; font-weight:bold; cursor:pointer;">L∆ØU</button>
            </div>
        </div>

        <div class="friend-menu" id="friend-menu"></div>
        <div id="chat-box"></div>

        <div class="input-area">
            <label class="btn-icon">üìÅ<input type="file" id="file-input" style="display:none" onchange="handleFile(this)"></label>
            <input type="text" id="message-input" class="main-input" placeholder="Aa..." oninput="sendTyping()">
            <button class="btn-send" onclick="sendMessage()">‚Üë</button>
        </div>
    </div>

    <audio id="snd-in" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>

    <script>
        let peer, conn;
        let currentChatId = '';
        let typingTimeout;
        const S_ID = 'crystal_4g_id';
        const S_FRIENDS = 'crystal_4g_friends';
        const S_MSGS = 'crystal_4g_msgs';

        function init() {
            const id = localStorage.getItem(S_ID) || Math.floor(1000 + Math.random() * 9000).toString();
            localStorage.setItem(S_ID, id);

            // FIX 4G: Th√™m ICE Servers c·ªßa Google
            peer = new Peer(id, {
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', i => document.getElementById('my-id').innerText = "ID: " + i);
            
            peer.on('connection', c => {
                c.on('open', () => {
                    syncPending(c);
                    setupConn(c);
                    if(currentChatId === '') { currentChatId = c.peer; loadFriends(); loadChat(); }
                });
            });

            peer.on('error', err => {
                console.error(err);
                if(err.type === 'peer-unavailable') updateStatus("B·∫†N ƒêANG OFFLINE", "offline");
            });

            loadFriends();
        }

        function setupConn(c) {
            conn = c;
            c.on('data', data => {
                if (data.type === 'typing') {
                    showTyping();
                } else {
                    saveMessage(c.peer, data, 'received');
                    if (currentChatId === c.peer) loadChat();
                    else markNew(c.peer);
                    document.getElementById('snd-in').play().catch(()=>{});
                }
            });
            updateStatus("ƒê√É K·∫æT N·ªêI", "online");
        }

        function sendTyping() {
            if (conn && conn.open) conn.send({ type: 'typing' });
        }

        function showTyping() {
            const indicator = document.getElementById('typing-indicator');
            indicator.innerText = "N√≠ ƒëang so·∫°n tin...";
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => indicator.innerText = "", 2000);
        }

        function handleFile(input) {
            const file = input.files[0];
            if (!file || !currentChatId) return;
            const reader = new FileReader();
            reader.onload = () => {
                const data = { type: 'file', name: file.name, mime: file.type, content: reader.result };
                if (conn && conn.open && conn.peer === currentChatId) {
                    conn.send(data);
                    saveMessage(currentChatId, data, 'sent');
                } else {
                    saveMessage(currentChatId, data, 'sent', true);
                    tryConnect(currentChatId);
                }
                loadChat();
            };
            reader.readAsDataURL(file);
        }

        function sendMessage() {
            const val = document.getElementById('message-input').value.trim();
            if (!val || !currentChatId) return;
            const data = { type: 'text', content: val };
            if (conn && conn.open && conn.peer === currentChatId) {
                conn.send(data);
                saveMessage(currentChatId, data, 'sent');
            } else {
                saveMessage(currentChatId, data, 'sent', true);
                tryConnect(currentChatId);
            }
            document.getElementById('message-input').value = '';
            loadChat();
        }

        function tryConnect(id) {
            updateStatus("ƒêANG K·∫æT N·ªêI...", "");
            const c = peer.connect(id);
            c.on('open', () => { syncPending(c); setupConn(c); });
        }

        function syncPending(connection) {
            let msgs = JSON.parse(localStorage.getItem(S_MSGS)) || [];
            msgs.forEach(m => {
                if (m.friendId === connection.peer && m.pending) {
                    connection.send(m.data);
                    delete m.pending;
                }
            });
            localStorage.setItem(S_MSGS, JSON.stringify(msgs));
        }

        function saveMessage(friendId, data, type, pending = false) {
            let msgs = JSON.parse(localStorage.getItem(S_MSGS)) || [];
            msgs.push({ friendId, data, type, pending, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
            localStorage.setItem(S_MSGS, JSON.stringify(msgs));
        }

        function loadChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            let msgs = JSON.parse(localStorage.getItem(S_MSGS)) || [];
            msgs.filter(m => m.friendId === currentChatId).forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.type} ${m.pending ? 'pending' : ''}`;
                let body = '';
                if (m.data.type === 'text') {
                    body = `<div>${m.data.content}</div>`;
                } else {
                    if (m.data.mime.startsWith('image/')) body = `<img src="${m.data.content}">`;
                    else if (m.data.mime.startsWith('video/')) body = `<video controls src="${m.data.content}"></video>`;
                    else body = `<a href="${m.data.content}" download="${m.data.name}" style="color:inherit">üìÅ ${m.data.name}</a>`;
                }
                div.innerHTML = body + `<div class="msg-time">${m.pending ? '‚è≥ ' : ''}${m.time}</div>`;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        }

        function addFriend() {
            const id = document.getElementById('peer-id-input').value.trim();
            if (!id) return;
            let friends = JSON.parse(localStorage.getItem(S_FRIENDS)) || [];
            if (!friends.find(f => f.id === id)) {
                friends.push({ id, name: "N√≠ " + id, new: false });
                localStorage.setItem(S_FRIENDS, JSON.stringify(friends));
                loadFriends();
            }
            document.getElementById('peer-id-input').value = '';
        }

        function loadFriends() {
            const menu = document.getElementById('friend-menu');
            menu.innerHTML = '';
            let friends = JSON.parse(localStorage.getItem(S_FRIENDS)) || [];
            friends.forEach(f => {
                const div = document.createElement('div');
                div.className = `friend-item ${currentChatId === f.id ? 'active' : ''} ${f.new ? 'has-new' : ''}`;
                div.innerText = f.name;
                div.onclick = () => {
                    currentChatId = f.id;
                    f.new = false;
                    localStorage.setItem(S_FRIENDS, JSON.stringify(friends));
                    tryConnect(f.id);
                    loadFriends(); loadChat();
                };
                menu.appendChild(div);
            });
        }

        function markNew(id) {
            let friends = JSON.parse(localStorage.getItem(S_FRIENDS)) || [];
            friends.forEach(f => { if(f.id === id) f.new = true; });
            localStorage.setItem(S_FRIENDS, JSON.stringify(friends));
            loadFriends();
        }

        function updateStatus(t, c) {
            const b = document.getElementById('status-badge');
            b.innerText = t; b.className = c;
        }

        init();
    </script>
</body>
</html>
