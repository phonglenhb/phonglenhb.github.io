<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Onet Crystal Pro 2026 üíé</title>
    <style>
        :root { 
            --accent: #d4ff00; 
            --tet-red: #ff3e3e;
            --glass: rgba(0, 0, 0, 0.85);
            --crystal-border: 1px solid rgba(255, 255, 255, 0.2);
        }
        body { 
            margin: 0; background: #000 url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1932') no-repeat center center fixed;
            background-size: cover; font-family: -apple-system, sans-serif; color: white;
            display: flex; flex-direction: column; align-items: center; height: 100dvh; overflow: hidden;
            transition: 0.8s;
        }

        /* KH·ªûI ƒê·ªòNG */
        #start-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn-start {
            padding: 20px 50px; background: var(--accent); color: black; border: none;
            border-radius: 50px; font-weight: 900; font-size: 24px; cursor: pointer;
            box-shadow: 0 0 30px var(--accent); animation: pulse 1.5s infinite;
        }

        /* HEADER & TIMER */
        .header { width: 100%; padding: 15px 0; background: var(--glass); display: flex; flex-direction: column; align-items: center; border-bottom: 2px solid #f1c40f; }
        .info-row { width: 90%; display: flex; justify-content: space-around; font-weight: 900; font-size: 18px; color: #f1c40f; margin-bottom: 10px; }
        .timer-outer { width: 85%; height: 22px; background: #331a00; border: 3px solid #f1c40f; border-radius: 20px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff00ff, #00ffff, #00ff00, #ffff00); transition: width 0.5s linear; }

        /* MENU */
        .tool-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 95%; margin: 15px 0; }
        .tool-btn { background: rgba(255,255,255,0.1); border: var(--crystal-border); border-radius: 12px; padding: 12px; color: white; cursor: pointer; font-weight: bold; font-size: 12px; backdrop-filter: blur(5px); }
        .tool-btn:active { background: var(--accent); color: black; }

        /* BOARD */
        .board-container { position: relative; margin: auto; padding: 25px; background: rgba(0,0,0,0.3); border-radius: 20px; border: var(--crystal-border); }
        #game-board { display: grid; grid-template-columns: repeat(12, 42px); gap: 5px; }
        .tile { 
            width: 42px; height: 52px; background: rgba(255,255,255,0.05); /* Liquid Glass 5% */
            border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
            display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer;
            transition: 0.1s;
        }
        .tile.selected { background: var(--tet-red); border-color: white; box-shadow: 0 0 15px var(--tet-red); transform: scale(1.1); z-index: 2; }
        .tile.hidden { visibility: hidden; pointer-events: none; }

        #connector-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .line { stroke: var(--accent); stroke-width: 6; fill: none; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0 0 8px var(--accent)); animation: fadeOut 0.4s forwards; }
        
        @keyframes fadeOut { from {opacity: 1;} to {opacity: 0;} }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
    </style>
</head>
<body>

    <div id="start-screen" onclick="startApp()">
        <button class="btn-start">CH∆†I NGAY üß®</button>
        <p style="color: #666; margin-top: 15px;">Full H√†o Quang - Audio Folder New</p>
    </div>

    <div class="header">
        <div class="info-row">
            <div>üí∞ <span id="money">500</span></div>
            <div>LV <span id="lv">1</span></div>
            <div>DREAM <span id="score">0</span></div>
        </div>
        <div class="timer-outer"><div id="timer-bar"></div></div>
    </div>

    <div class="tool-menu">
        <button class="tool-btn" onclick="useHint()">üîç G·ª¢I √ù (500 xu)</button>
        <button class="tool-btn" onclick="nextBg()">üñºÔ∏è ƒê·ªîI N·ªÄN</button>
        <button class="tool-btn" onclick="nextSong()">üéµ ƒê·ªîI NH·∫†C</button>
    </div>

    <div class="board-container" id="board-cont">
        <div id="game-board"></div>
        <svg id="connector-svg"></svg>
    </div>

    <audio id="bg-music" loop src="Nhac.mp3"></audio>
    <audio id="s-match" src="dung.mp3"></audio>
    <audio id="s-oto" src="sai.mp3"></audio>
    <audio id="s-click" src="khi_nhan_nut.mp3"></audio>

    <script>
        const COLS = 12, ROWS = 7;
        const icons = ['üßß','üèÆ','üçä','üå∏','üß®','üéã','üí∞','‚ú®','üçé','üçë','üçç','üçâ','üç±','ü¶Å','üéç','ü™Å'];
        
        const bgs = [
            'url("https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1932")',
            'url("https://images.unsplash.com/photo-1467139701929-18c0d27a7516?q=80&w=2070")',
            'url("https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070")'
        ];

        let matrix = [], selected = null, money = 500, score = 0, lv = 1, bgIdx = 0, timeLeft = 100, timerInt;

        function playSound(id) {
            const s = document.getElementById(id);
            if (s) { s.currentTime = 0; s.play().catch(() => {}); }
        }

        function startApp() {
            document.getElementById('start-screen').style.display = 'none';
            const m = document.getElementById('bg-music');
            m.volume = 0.4;
            m.play().catch(() => {});
            playSound('s-click');
            loadOrInit();
        }

        function loadOrInit() {
            const saved = JSON.parse(localStorage.getItem('onet_crystal_pro_save'));
            if(saved) {
                matrix = saved.matrix; money = saved.money; lv = saved.lv; score = saved.score;
                updateUI(); renderBoard(); startTimer();
            } else { initGame(); }
        }

        function initGame() {
            clearInterval(timerInt); timeLeft = 100;
            matrix = Array.from({ length: ROWS + 2 }, () => Array(COLS + 2).fill(null));
            let items = [];
            for (let i = 0; i < (ROWS * COLS) / 2; i++) items.push(icons[i % icons.length], icons[i % icons.length]);
            items.sort(() => Math.random() - 0.5);
            let k = 0;
            for (let r = 1; r <= ROWS; r++) for (let c = 1; c <= COLS; c++) matrix[r][c] = items[k++];
            
            ensureSolvable(); renderBoard(); startTimer(); saveGame();
        }

        function renderBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            document.body.style.backgroundImage = bgs[bgIdx];
            for (let r = 1; r <= ROWS; r++) {
                for (let c = 1; c <= COLS; c++) {
                    const div = document.createElement('div');
                    div.className = 'tile' + (matrix[r][c] ? '' : ' hidden');
                    div.innerHTML = matrix[r][c] || '';
                    div.id = `t-${r}-${c}`;
                    div.onclick = () => handleSelect(div, r, c);
                    board.appendChild(div);
                }
            }
            updateUI();
        }

        function handleSelect(el, r, c) {
            if (!matrix[r][c]) return;
            playSound('s-click');

            if (!selected) {
                selected = { el, r, c }; el.classList.add('selected');
            } else {
                if (selected.r === r && selected.c === c) {
                    el.classList.remove('selected'); selected = null; return;
                }
                
                const path = findPath(selected.r, selected.c, r, c);
                if (matrix[selected.r][selected.c] === matrix[r][c] && path) {
                    drawPath(path);
                    playSound('s-match');
                    matrix[selected.r][selected.c] = matrix[r][c] = null;
                    money += 20; score += 10;
                    setTimeout(() => { ensureSolvable(); renderBoard(); checkWin(); saveGame(); }, 200);
                } else {
                    playSound('s-oto');
                }
                selected.el.classList.remove('selected'); selected = null;
            }
        }

        function findPath(r1, c1, r2, c2) {
            const queue = [{ r: r1, c: c1, dir: -1, turns: 0, path: [{ r: r1, c: c1 }] }];
            const visited = new Map();
            while (queue.length > 0) {
                const curr = queue.shift();
                if (curr.turns > 2) continue;
                if (curr.r === r2 && curr.c === c2) return curr.path;
                const ds = [[-1, 0], [1, 0], [0, -1], [0, 1]];
                for (let i = 0; i < 4; i++) {
                    let nr = curr.r + ds[i][0], nc = curr.c + ds[i][1];
                    if (nr >= 0 && nr <= ROWS + 1 && nc >= 0 && nc <= COLS + 1) {
                        if (matrix[nr][nc] === null || (nr === r2 && nc === c2)) {
                            let nTurns = (curr.dir !== -1 && curr.dir !== i) ? curr.turns + 1 : curr.turns;
                            if (nTurns <= 2) {
                                let key = `${nr}-${nc}-${i}`;
                                if (!visited.has(key) || visited.get(key) > nTurns) {
                                    visited.set(key, nTurns);
                                    queue.push({ r: nr, c: nc, dir: i, turns: nTurns, path: [...curr.path, { r: nr, c: nc }] });
                                }
                            }
                        }
                    }
                }
            }
            return null;
        }

        function ensureSolvable() {
            let possible = false;
            for(let r1=1; r1<=ROWS; r1++) for(let c1=1; c1<=COLS; c1++) {
                if(!matrix[r1][c1]) continue;
                for(let r2=1; r2<=ROWS; r2++) for(let c2=1; c2<=COLS; c2++) {
                    if((r1===r2 && c1===c2) || matrix[r1][c1] !== matrix[r2][c2]) continue;
                    if(findPath(r1,c1,r2,c2)) { possible = true; break; }
                }
                if(possible) break;
            }
            if(!possible && matrix.flat().some(v => v !== null)) shuffleBoard();
        }

        function shuffleBoard() {
            let items = matrix.flat().filter(v => v !== null);
            items.sort(() => Math.random() - 0.5);
            let k = 0;
            for (let r = 1; r <= ROWS; r++) for (let c = 1; c <= COLS; c++) if (matrix[r][c]) matrix[r][c] = items[k++];
            renderBoard();
        }

        function drawPath(path) {
            const svg = document.getElementById('connector-svg');
            let pts = path.map(p => {
                const x = (p.c - 1) * 47 + 45;
                const y = (p.r - 1) * 57 + 50;
                return `${x},${y}`;
            });
            const line = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            line.setAttribute("points", pts.join(" ")); line.setAttribute("class", "line");
            svg.appendChild(line); setTimeout(() => line.remove(), 400);
        }

        function startTimer() {
            timerInt = setInterval(() => {
                timeLeft -= 0.35;
                document.getElementById('timer-bar').style.width = timeLeft + "%";
                if (timeLeft <= 0) { clearInterval(timerInt); alert("H·∫æT GI·ªú R·ªíI N√ç!"); location.reload(); }
            }, 1000);
        }

        function useHint() {
            if (money < 500) return alert("KH√îNG ƒê·ª¶ XU!");
            playSound('s-click');
            for(let r1=1; r1<=ROWS; r1++) for(let c1=1; c1<=COLS; c1++) {
                if(!matrix[r1][c1]) continue;
                for(let r2=1; r2<=ROWS; r2++) for(let c2=1; c2<=COLS; c2++) {
                    if((r1===r2 && c1===c2) || matrix[r1][c1] !== matrix[r2][c2]) continue;
                    if(findPath(r1,c1,r2,c2)) {
                        money -= 500;
                        document.getElementById(`t-${r1}-${c1}`).style.boxShadow = "0 0 20px var(--accent)";
                        document.getElementById(`t-${r2}-${c2}`).style.boxShadow = "0 0 20px var(--accent)";
                        updateUI();
                        setTimeout(() => renderBoard(), 1000); return;
                    }
                }
            }
        }

        function nextSong() { playSound('s-click'); document.getElementById('bg-music').play(); }
        function nextBg() { playSound('s-click'); bgIdx = (bgIdx + 1) % bgs.length; renderBoard(); }
        function updateUI() { 
            document.getElementById('money').innerText = money; 
            document.getElementById('lv').innerText = lv; 
            document.getElementById('score').innerText = score; 
        }
        function checkWin() { if (matrix.flat().every(v => v === null)) { lv++; money += 500; initGame(); } }
        function saveGame() { localStorage.setItem('onet_crystal_pro_save', JSON.stringify({ matrix, money, lv, score })); }
    </script>
</body>
</html>
