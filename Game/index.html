<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Onet Crystal Pro 2026 üíé</title>
    <style id="theme-style">
        :root { 
            --accent: #d4ff00; 
            --line-color: #00ff00;
            --glass: rgba(0, 0, 0, 0.8);
            --crystal: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        * { 
            box-sizing: border-box; 
            touch-action: manipulation; 
            -webkit-user-select: none;
            user-select: none;
            outline: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            margin: 0; padding: 0;
            background-color: #000;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover; 
            font-family: -apple-system, Helvetica, Arial, sans-serif; color: white;
            display: flex; flex-direction: column; height: 100dvh; overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            -webkit-overflow-scrolling: touch;
        }

        /* HEADER */
        .header { background: var(--glass); padding: 5px 0; border-bottom: 1px solid #f1c40f; flex-shrink: 0; z-index: 10; }
        .info { display: flex; justify-content: space-around; font-weight: 900; font-size: 13px; color: #f1c40f; }
        .timer-box { width: 95%; height: 5px; background: rgba(255,255,255,0.1); border-radius: 10px; margin: 4px auto; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000); }

        /* MENU & N√öT GIAO DI·ªÜN CRYSTAL (M·∫∂C ƒê·ªäNH) */
        .menu { display: flex; justify-content: center; gap: 8px; padding: 8px; flex-shrink: 0; z-index: 10; flex-wrap: wrap; }
        .btn { 
            background: rgba(255,255,255,0.1); border: var(--crystal); border-radius: 8px; 
            padding: 8px 12px; color: white; font-size: 10px; font-weight: bold; cursor: pointer;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); text-transform: uppercase;
        }

        /* V√ôNG GAME */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; padding: 10px; overflow: hidden; }
        #board { display: grid; grid-template-columns: repeat(12, 1fr); gap: 0.5dvmin; width: fit-content; max-height: 70dvh; z-index: 5; }

        /* √î B√ÄN C·ªú GIAO DI·ªÜN CRYSTAL */
        .tile { 
            aspect-ratio: 1 / 1; height: 8.5dvmin; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
            display: flex; align-items: center; justify-content: center; font-size: 5dvmin; 
            transition: transform 0.2s;
        }
        .tile.active { background: #ff3e3e; border-color: white; transform: scale(1.1); z-index: 6; box-shadow: 0 0 15px #ff3e3e; }
        .tile.hide { visibility: hidden; pointer-events: none; }

        /* --- CH·∫æ ƒê·ªò CLASSIC (iPHONE 4) --- */
        /* N√∫t b·∫•m iPhone 4 */
        body.classic .btn {
            background: linear-gradient(to bottom, #7d7e7d 0%, #0e0e0e 100%);
            border: 1px solid #000; border-radius: 5px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 0 1px 2px rgba(0,0,0,0.8);
            color: #eee; text-shadow: 0 -1px 0 #000;
            backdrop-filter: none; -webkit-backdrop-filter: none;
        }
        /* Header iPhone 4 */
        body.classic .header { background: linear-gradient(to bottom, #45484d 0%, #000000 100%); border-bottom: 1px solid #222; }
        body.classic .info { color: #fff; text-shadow: 0 -1px 0 #000; }
        /* √î b√†n c·ªù iPhone 4 */
        body.classic .tile {
            background: linear-gradient(135deg, #ffffff 0%, #e5e5e5 100%);
            border: 1px solid #999; border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3), inset 0 1px 0 #fff; color: #333;
        }
        body.classic .tile.active { background: #ffcc00; border-color: #ff9900; box-shadow: 0 0 12px #ffcc00, inset 0 1px 0 #fff; }

        #line-canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 100; }
        .shuffle-shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-5px); }
        }
    </style>
</head>
<body oncontextmenu="return false;" onload="autoStart()"> 

<div class="header">
    <div class="info">
        <div>üí∞ <span id="xu">500</span></div>
        <div>LV <span id="lv">1</span></div>
        <div>PTS <span id="pts">0</span></div>
    </div>
    <div class="timer-box"><div id="timer-bar"></div></div>
</div>

<div class="menu">
    <div class="btn" style="color: #00ffff;" onclick="toggleUI()" ontouchend="event.preventDefault(); toggleUI();">üåì GIAO DI·ªÜN</div>
    <div class="btn" onclick="toggleFullScreen()" ontouchend="event.preventDefault(); toggleFullScreen();">üñ•Ô∏è FULL</div>
    <div class="btn" onclick="autoFind()" ontouchend="event.preventDefault(); autoFind();">üîç G·ª¢I √ù (300)</div>
    <div class="btn" onclick="manualShuffle()" ontouchend="event.preventDefault(); manualShuffle();">üîÑ ƒê·∫¢O (100)</div>
    <div class="btn" onclick="changeBg()" ontouchend="event.preventDefault(); changeBg();">üñºÔ∏è N·ªÄN</div>
</div>

<div class="game-area">
    <canvas id="line-canvas"></canvas>
    <div id="board"></div>
</div>

<audio id="m_bg" loop src="Nhac.mp3"></audio>
<audio id="s_ok" src="dung.mp3"></audio>
<audio id="s_no" src="sai.mp3"></audio>
<audio id="s_tap" src="khi_nhan_nut.mp3"></audio>

<script>
    const R=7, C=12;
    const icons = ['üßß','üèÆ','üçä','üå∏','üß®','üéã','üí∞','‚ú®','üçé','üçë','üçç','üçâ','üç±','ü¶Å','üéç','ü™Å','üçá','üçì','ü•®','ü•ë'];
    const bgs = ['1.jpeg', '2.jpeg', '3.jpeg', '4.jpeg', '5.jpeg', '6.jpeg', '7.jpeg', '8.jpg'];
    let currentBgIndex = 0;
    let map=[], pick=null, xu=500, pts=0, lv=1, time=100, timer;

    function autoStart() {
        const savedMode = localStorage.getItem('onet_ui_mode') || 'crystal';
        if(savedMode === 'classic') document.body.classList.add('classic');
        
        const hasSave = loadFromDevice(); 
        document.body.style.backgroundImage = `url('${bgs[currentBgIndex]}')`;
        
        if(hasSave && map.length > 0) {
            draw(); 
            startTimer();
        } else {
            init();
        }
        resizeCanvas();
        window.onresize = resizeCanvas;
        
        document.body.addEventListener('touchstart', () => {
            document.getElementById('m_bg').play().catch(()=>{});
        }, {once: true});
    }

    function toggleFullScreen() {
        sound('s_tap');
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {});
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function toggleUI() {
        sound('s_tap');
        document.body.classList.toggle('classic');
        const isClassic = document.body.classList.contains('classic');
        localStorage.setItem('onet_ui_mode', isClassic ? 'classic' : 'crystal');
    }

    function saveToDevice() {
        const data = { xu, lv, pts, currentBgIndex, map, time };
        localStorage.setItem('onet_pro_save', JSON.stringify(data));
    }

    function loadFromDevice() {
        const saved = localStorage.getItem('onet_pro_save');
        if (saved) {
            const data = JSON.parse(saved);
            xu = data.xu ?? 500;
            lv = data.lv ?? 1;
            pts = data.pts ?? 0;
            currentBgIndex = data.currentBgIndex ?? 0;
            time = data.time ?? 100;
            if(data.map) map = data.map;
            return true;
        }
        return false;
    }

    function sound(id){ 
        const a=document.getElementById(id); 
        if(a){ 
            a.currentTime=0; 
            a.play().catch(e => {});
        } 
    }

    function changeBg() {
        sound('s_tap');
        currentBgIndex = (currentBgIndex + 1) % bgs.length;
        document.body.style.backgroundImage = `url('${bgs[currentBgIndex]}')`;
        saveToDevice();
    }

    function resizeCanvas() {
        const cvs = document.getElementById('line-canvas');
        const area = document.querySelector('.game-area');
        if(cvs && area) {
            cvs.width = area.clientWidth;
            cvs.height = area.clientHeight;
        }
    }

    function init(){
        clearInterval(timer); time=100;
        map = Array.from({length:R+2},()=>Array(C+2).fill(null));
        let items = [];
        for(let i=0; i<(R*C)/2; i++) items.push(icons[i%icons.length], icons[i%icons.length]);
        items.sort(()=>Math.random()-0.5);
        let k=0;
        for(let r=1; r<=R; r++) for(let c=1; c<=C; c++) map[r][c]=items[k++];
        checkAndShuffle(); draw(); startTimer();
    }

    function draw(){
        const b = document.getElementById('board'); 
        if(!b) return;
        b.innerHTML='';
        for(let r=1; r<=R; r++) for(let c=1; c<=C; c++){
            const d = document.createElement('div');
            d.className = 'tile' + (map[r][c]?'':' hide');
            d.id = `tile-${r}-${c}`;
            d.innerHTML = map[r][c]||'';
            
            d.ontouchend = (e) => {
                e.preventDefault(); 
                click(d, r, c);
            };
            d.onclick = (e) => {
                click(d, r, c);
            };
            
            b.appendChild(d);
        }
        document.getElementById('xu').innerText=xu;
        document.getElementById('lv').innerText=lv;
        document.getElementById('pts').innerText=pts;
        saveToDevice();
    }

    function drawPath(path) {
        const cvs = document.getElementById('line-canvas');
        const ctx = cvs.getContext('2d');
        const board = document.getElementById('board');
        const rect = board.getBoundingClientRect();
        const areaRect = document.querySelector('.game-area').getBoundingClientRect();
        const getCoord = (r, c) => {
            const w = rect.width / C;
            const h = rect.height / R;
            return { x: rect.left - areaRect.left + (c - 0.5) * w, y: rect.top - areaRect.top + (r - 0.5) * h };
        };
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        ctx.beginPath();
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 5;
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00ff00';
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        let start = getCoord(path[0].r, path[0].c);
        ctx.moveTo(start.x, start.y);
        for(let i=1; i<path.length; i++){
            let pt = getCoord(path[i].r, path[i].c);
            ctx.lineTo(pt.x, pt.y);
        }
        ctx.stroke();
        setTimeout(() => ctx.clearRect(0, 0, cvs.width, cvs.height), 400);
    }

    function click(el,r,c){
        if(!map[r][c]) return;
        sound('s_tap');
        if(!pick){ pick={el,r,c}; el.classList.add('active'); }
        else {
            if(pick.r===r && pick.c===c){ el.classList.remove('active'); pick=null; return; }
            let path = checkPath(pick.r, pick.c, r, c);
            if(map[pick.r][pick.c]===map[r][c] && path){
                drawPath(path);
                handleMatch(pick.r, pick.c, r, c);
                pick = null;
            } else { 
                sound('s_no');
                pick.el.classList.remove('active');
                pick = {el, r, c};
                el.classList.add('active');
            }
        }
    }

    function handleMatch(r1,c1,r2,c2){
        sound('s_ok');
        map[r1][c1] = map[r2][c2] = null;
        xu += 10; pts += 5;
        if(Math.random() < 0.03) shuffle();
        checkAndShuffle();
        setTimeout(draw, 150);
        if(map.flat().every(v => v === null)){ lv++; xu+=200; localStorage.removeItem('onet_pro_save'); init(); }
    }

    function checkPath(r1,c1,r2,c2){
        const q=[{r:r1,c:c1,d:-1,t:0,p:[{r:r1,c:c1}]}]; 
        const v=new Map();
        while(q.length>0){
            const curr=q.shift();
            if(curr.t>2) continue;
            if(curr.r===r2 && curr.c===c2) return curr.p;
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc],i)=>{
                let nr=curr.r+dr, nc=curr.c+dc;
                if(nr>=0 && nr<=R+1 && nc>=0 && nc<=C+1){
                    if(map[nr][nc]===null || (nr===r2 && nc===c2)){
                        let nt = (curr.d!==-1 && curr.d!==i)?curr.t+1:curr.t;
                        let k=`${nr}-${nc}-${i}`;
                        if(!v.has(k) || v.get(k)>nt){ v.set(k,nt); q.push({r:nr,c:nc,d:i,t:nt,p:[...curr.p,{r:nr,c:nc}]}); }
                    }
                }
            });
        } return null;
    }

    function checkAndShuffle(){
        let has = false;
        for(let r1=1; r1<=R; r1++) for(let c1=1; c1<=C; c1++){
            if(!map[r1][c1]) continue;
            for(let r2=1; r2<=R; r2++) for(let c2=1; c2<=C; c2++){
                if((r1===r2 && c1===c2) || !map[r2][c2] || map[r1][c1]!==map[r2][c2]) continue;
                if(checkPath(r1,c1,r2,c2)) { has=true; break; }
            }
            if(has) break;
        }
        if(!has && !map.flat().every(v=>v===null)) { shuffle(); checkAndShuffle(); }
    }

    function shuffle(){
        const b = document.getElementById('board');
        if(!b) return;
        b.classList.add('shuffle-shake');
        let items = map.flat().filter(v => v !== null);
        items.sort(() => Math.random() - 0.5);
        let k=0;
        for(let r=1; r<=R; r++) for(let c=1; c<=C; c++) if(map[r][c]) map[r][c] = items[k++];
        setTimeout(() => { b.classList.remove('shuffle-shake'); draw(); }, 400);
    }

    function manualShuffle(){ 
        if(xu>=100){ 
            xu-=100; 
            sound('s_tap'); 
            shuffle(); 
            document.getElementById('xu').innerText=xu;
        } 
    }
    
    function autoFind(){
        if(xu<300) return;
        for(let r1=1; r1<=R; r1++) for(let c1=1; c1<=C; c1++){
            if(!map[r1][c1]) continue;
            for(let r2=1; r2<=R; r2++) for(let c2=1; c2<=C; c2++){
                if((r1===r2 && c1===c2) || !map[r2][c2] || map[r1][c1]!==map[r2][c2]) continue;
                let path = checkPath(r1,c1,r2,c2);
                if(path){ 
                    xu-=300; 
                    drawPath(path); 
                    handleMatch(r1,c1,r2,c2); 
                    document.getElementById('xu').innerText=xu;
                    return; 
                }
            }
        }
    }

    function startTimer(){
        if(timer) clearInterval(timer);
        timer = setInterval(()=>{
            time -= 0.15;
            const bar = document.getElementById('timer-bar');
            if(bar) bar.style.width = time+"%";
            if(time <= 15) saveToDevice();
            if(time<=0){ clearInterval(timer); localStorage.removeItem('onet_pro_save'); alert("H·∫øt gi·ªù! Ch∆°i l·∫°i nh√© n√≠."); location.reload(); }
        },1000);
    }
</script>
</body>
</html>
